# Исправление проблемы с разрешением клипов (360p вместо исходного качества)

## Проблема
Исходное видео загружается в высоком качестве (720p или 1080p), но обрезанные клипы иногда получаются в 360p.

## Причина
Проблема была в format selector в yt-dlp, который мог не всегда выбирать максимальное доступное качество, особенно для видео где 1080p недоступно или используются специфические кодеки.

## Решение

### 1. Улучшен format selector в yt-dlp
**Файл:** `app/ytdlp_wrapper.py` (строка 54)

Изменен format string для приоритизации максимального качества:
```python
"format": "bestvideo[height<=1080][ext=mp4]+bestaudio[ext=m4a]/bestvideo[height<=1080]+bestaudio/best[height<=1080]/bestvideo+bestaudio/best"
```

Это обеспечивает:
- Приоритет MP4 видео + M4A аудио для максимальной совместимости
- Fallback на другие форматы если MP4 недоступен
- Всегда выбирается максимальное качество до 1080p
- Работает для видео в 720p, 1080p и других разрешениях

### 2. Упрощен concat filter
**Файлы:** `app/auto_pipeline.py`, `script.py`, `upscale/vastai_deployment/server.py`

Убрано принудительное масштабирование к 1920x1080, так как:
- Все фрагменты извлекаются из ОДНОГО исходного видео
- Они уже имеют одинаковое разрешение (720p, 1080p, или другое)
- Нет необходимости в upscale/downscale
- Concat filter корректно работает с фрагментами одинакового разрешения

## Тестирование
После применения исправления:

### Для видео в 1080p:
- Загрузите видео в 1080p (например: https://www.youtube.com/watch?v=uXCR3fyATFE)
- Создайте клипы с несколькими фрагментами
- Проверьте разрешение: `ffprobe -v error -select_streams v:0 -show_entries stream=width,height -of csv=s=x:p=0 clip.mp4`
- **Ожидаемый результат:** 1920x1080

### Для видео в 720p:
- Загрузите видео, где 1080p недоступно
- Создайте клипы
- Проверьте разрешение аналогично
- **Ожидаемый результат:** 1280x720 (или исходное разрешение видео)

## Важно
Система теперь **сохраняет исходное качество видео** без upscaling или downscaling:
- Видео в 1080p → клипы в 1080p
- Видео в 720p → клипы в 720p
- Видео в других разрешениях → клипы в том же разрешении

## Дата исправления
2024-10-27
